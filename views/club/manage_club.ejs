<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™í˜¸íšŒ ìˆ˜ì •í˜ì´ì§€</title>
    <link rel="stylesheet" href="/public/css/club/manage_club.css">
</head>
<body>
    <%- include("../common/header", {data}) %>
    <div class = "main-content"> 
        <div id = "club-form">
            <div class = "form-header">
                <h2 class = "form-title"> ë™í˜¸íšŒ ìˆ˜ì • ì •ë³´ ì…ë ¥</h2>
            </div>
            
            <form>
                <div class = "addFrom-group">
                    <label class = "label required">ë™í˜¸íšŒ ì´ë¦„</label>
                    <input type="text" class = "form-input" id = "club_name" value="<%= club.name %>" required>
                </div>
                <div class = "addFrom-group">
                    <label class = "label required">ë™í˜¸íšŒ ì„¤ëª…</label>
                    <textarea class = "form-input-txtarea" id="club_information"><%= club.introduction %></textarea>
                </div>
                <div class = "addFrom-group">
                    <label class = "label required">ë™í˜¸íšŒ ëŒ€í‘œ ì´ë¯¸ì§€ (4:3 ë¹„ìœ¨)</label>
                    <div class = "form-container">
                        <div class = "image-upload">
                            <div class = "upload-icon">ğŸ“·</div>
                            <p class = "upload-info">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”.(ë¯¸ì„ íƒì‹œ ì´ë¯¸ì§€ëŠ” ìˆ˜ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)</p>
                            <input type="file" id = "club-image">
                        </div>
                    </div>
                </div>
                <div class = "addFrom-group">
                    <label class="label">íƒœê·¸</label>
                    <div class="add-tag">
                        <% club.Tags.forEach(tag => { %>
                            <span class="tag">
                                <%= tag.tag %> <span class="tag-remove">Ã—</span>
                            </span>
                            <% }) %>
                        <input type="text" class="tag-input" id="club_tags" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”">
                      </div>
                </div>
                <div class = "addFrom-group">
                    <label class = "label required">ë©¤ë²„ ì •ì›</label>
                    <div class = "member-container">
                        <input type="number" class="memeber-input" min="2" value="<%= club.member_limit %>">
                        <span style="color:#666">ëª…</span>
                    </div>
                    <p class = "member-noti">ìµœì†Œ 2ëª… ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                </div>
                <div class="addForm-btn-container">
                    <button type="button" class="btn btn-cancel">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-ok">ë™í˜¸íšŒ ìˆ˜ì •í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const tagInput = document.getElementById("club_tags");
        const tagContainer = tagInput.parentElement;

        tagContainer.querySelectorAll(".tag-remove").forEach(removeBtn => {
            removeBtn.addEventListener("click", () => {
            removeBtn.parentElement.remove();
            });
        });
        tagInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
            e.preventDefault();
            setTimeout(() => {
                const tagText = tagInput.value.trim();
                if (!tagText) return;

                const existingTags = tagContainer.querySelectorAll(".tag");
                const duplicate = Array.from(existingTags).some(tag =>
                    tag.firstChild.textContent.trim() === tagText
                );
                if (duplicate) {
                    tagInput.value = "";
                return;
                }
                const tag = document.createElement("span");
                tag.className = "tag";
                tag.innerHTML = `${tagText} <span class="tag-remove">Ã—</span>`;
                tag.querySelector(".tag-remove").addEventListener("click", () => {
                    tag.remove();
                });

                tagContainer.insertBefore(tag, tagInput);
                tagInput.value = "";
            }, 0);
            }
        });
});


    document.addEventListener("DOMContentLoaded", () => {
        const club_image = document.getElementById("club-image");
        const imageUploadBox = document.querySelector(".image-upload");
        const icon = document.querySelector(".upload-icon");
        const upload_info = document.querySelector(".upload-info");
    
        imageUploadBox.addEventListener("click", () => {
        club_image.click();
        });
    
      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
      club_image.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
    
        const reader = new FileReader();
        reader.onload = function (event) {
            const existingImg = imageUploadBox.querySelector("img");
            if (existingImg) existingImg.remove();
        
            const previewImg = document.createElement("img");
            previewImg.src = event.target.result;
            previewImg.alt = "ë™í˜¸íšŒ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°";
            previewImg.style.width = "80%";
            previewImg.style.aspectRatio = "4 / 3";
            previewImg.style.objectFit = "cover";
            previewImg.style.borderRadius = "8px";
    
            icon.style.display = "none";
            upload_info.style.display = "none";
    
            imageUploadBox.appendChild(previewImg);
        };
        reader.readAsDataURL(file);
    });
    
      // ë™í˜¸íšŒ ìˆ˜ì • ë²„íŠ¼ í´ë¦­
        document.querySelector(".btn-ok").addEventListener("click", async () => {
        const name = document.getElementById("club_name").value.trim();
        const info = document.getElementById("club_information").value.trim();
        const limit = document.querySelector(".memeber-input").value.trim();
        const tags = Array.from(document.querySelectorAll(".tag")).map(tag =>
        tag.firstChild.textContent.trim()
        );
        const file = club_image.files[0];
    
        if (!name || !info || !limit) {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
    
        const formData = new FormData();
        formData.append("name", name);
        formData.append("introduction", info);
        formData.append("member_limit", limit);
        formData.append("tags", JSON.stringify(tags));
        if (file) {
            formData.append("image", file); // ì´ë¯¸ì§€ ìˆëŠ” ê²½ìš°ë§Œ 
        }
    
        try {
            const res = await axios.post(`/clubs/detail/<%= club.club_id %>/manage`, formData, {
                headers: {
                "Content-Type": "multipart/form-data"
            }
        });
    
            if (res.data.state === 200) {
                alert("ìˆ˜ì • ì™„ë£Œ!");
                window.location.assign(`/clubs/detail/<%= club.club_id %>`);
            } else {
                alert(res.data.message || "ìˆ˜ì • ì‹¤íŒ¨");
            }
        } catch (err) {
          console.error("ìˆ˜ì • ì˜¤ë¥˜", err);
          alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    });
    </script>
    
</html>